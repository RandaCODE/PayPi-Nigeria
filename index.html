<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PiPay Nigeria - Pay with Pi</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background: #f0f8ff; }
    button { padding: 15px 30px; font-size: 18px; background: #4CAF50; color: white; border: none; cursor: pointer; }
    #status { margin-top: 20px; font-size: 20px; }
  </style>
</head>
<body>
  <h1>PiPay Nigeria</h1>
  <p>Welcome! Pay for services with Pi.</p>
  <button onclick="authenticateAndPay()">Pay 10 Pi for Airtime Recharge</button>
  <div id="status"></div>

  <script>
    // Initialize Pi SDK (use sandbox: true for testing on Testnet)
    Pi.init({ version: "2.0" }); // Remove sandbox for Mainnet

    let userUid = null;
    const statusDiv = document.getElementById('status');

    // Handle any incomplete payments from previous sessions
    function onIncompletePaymentFound(payment) {
      fetch('https://your-backend.com/api/handle-incomplete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payment)
      }).then(res => res.json()).then(data => console.log('Incomplete handled:', data));
    }

    // Authenticate user and request payments permission
    async function authenticate() {
      const scopes = ['payments']; // Add 'username' if you want username
      try {
        const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
        userUid = auth.user.uid;
        statusDiv.innerHTML = `Hello, Pioneer! Ready to pay with Pi.`;
        console.log('Authenticated UID:', userUid);
        return true;
      } catch (err) {
        statusDiv.innerHTML = `Authentication failed: ${err.message}`;
        console.error(err);
        return false;
      }
    }

    // Initiate Pi payment (customize amount/memo/metadata)
    async function initiatePayment() {
      const paymentData = {
        amount: 10.0, // Amount in Pi
        memo: "Airtime Recharge â‚¦5000 - PiPay Nigeria", // Shown to user
        metadata: { service: "airtime", order_id: "ORDER_" + Date.now(), user_uid: userUid }
      };

      const callbacks = {
        onReadyForServerApproval: (paymentId) => {
          statusDiv.innerHTML = "Approving payment...";
          fetch('https://your-backend.com/api/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId })
          })
          .then(res => res.json())
          .then(data => console.log('Approved:', data))
          .catch(err => console.error('Approval error:', err));
        },
        onReadyForServerCompletion: (paymentId, txid) => {
          statusDiv.innerHTML = "Completing payment...";
          fetch('https://your-backend.com/api/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId, txid })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              statusDiv.innerHTML = "Payment successful! Airtime delivered.";
              // Deliver service here (e.g., call airtime API)
            }
          })
          .catch(err => console.error('Completion error:', err));
        },
        onCancel: (paymentId) => {
          statusDiv.innerHTML = "Payment cancelled.";
        },
        onError: (error, payment) => {
          statusDiv.innerHTML = `Error: ${error.message}`;
          console.error(error);
        }
      };

      try {
        await Pi.createPayment(paymentData, callbacks);
      } catch (err) {
        statusDiv.innerHTML = `Payment error: ${err.message}`;
      }
    }

    // Full flow: Authenticate then pay
    async function authenticateAndPay() {
      const authenticated = await authenticate();
      if (authenticated) {
        await initiatePayment();
      }
    }

    // Auto-auth on page load (optional)
    // authenticate();
  </script>
</body>
</html>