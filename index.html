<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PayPi Nigeria | Airtime ‚Ä¢ Data ‚Ä¢ Bills ‚Ä¢ Cashout</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    Pi.init({ version: "2.0" });   // ‚Üê THIS IS CRITICAL
  </script>

  <style>
    body { font-family: sans-serif; background: linear-gradient(135deg, #f3e7ff, #e3f2fd); margin:0; padding:20px; }
    .card { background:white; max-width:420px; margin:20px auto; border-radius:20px; padding:25px; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
    h1 { text-align:center; color:#5B00B4; }
    input, select { width:100%; padding:14px; margin:10px 0; border:1px solid #ddd; border-radius:12px; font-size:16px; }
    button { background:#5B00B4; color:white; padding:18px; font-size:20px; width:100%; border:none; border-radius:12px; margin-top:20px; }
    .hidden { display:none; }
    .rate { text-align:center; font-size:18px; margin:15px 0; color:#333; }
    .breakdown { background:#f9f3ff; padding:15px; border-radius:12px; margin:15px 0; }
  </style>
</head>
<body>

<div class="card">
  <h1>PayPi Nigeria üá≥üá¨</h1>
  <div class="rate">Live rate: <strong>1 Œ† = ‚Ç¶<span id="liveRate">349.45</span></strong></div>

  <select id="service" onchange="showFields()">
    <option value="">Choose Service</option>
    <option value="airtime">Airtime Top-up</option>
    <option value="data">Data Plans</option>
    <option value="electricity">Electricity Bill</option>
    <option value="betting">Betting Funding</option>
    <option value="cashout">Cashout to Bank</option>
  </select>

  <!-- All your existing fields (kept exactly as you had them) -->
  <div id="networkField" class="hidden">
    <select id="network">
      <option value="">Select Network</option>
      <option>MTN</option><option>Airtel</option><option>Glo</option><option>9mobile</option>
    </select>
  </div>

  <div id="dataPlans" class="hidden"></div>

  <input type="text" id="phone" placeholder="Phone Number" class="hidden"/>
  <input type="text" id="meter" placeholder="Meter Number" class="hidden"/>
  <input type="text" id="disco" placeholder="Disco (e.g. IKEJA ELECTRIC)" class="hidden"/>

  <div id="bankFields" class="hidden">
    <input type="text" id="bankName" placeholder="Bank Name"/><br>
    <input type="text" id="accNum" placeholder="Account Number"/><br>
    <input type="text" id="accName" placeholder="Account Name"/>
  </div>

  <input type="number" id="amount" placeholder="Amount (‚Ç¶) Minimum ‚Ç¶100" min="100" step="10"/>

  <div class="breakdown">
    <div>You pay: <strong><span id="totalPi">0</span> Œ†</strong></div>
    <div>You get: ‚Ç¶<span id="nairaAfterFee">0</span> (after 2.5% fee)</div>
    <div>Fee: ‚Ç¶<span id="feeAmount">0</span></div>
  </div>

  <button onclick="payWithPi()">Pay with Pi üëë</button>
  <p style="text-align:center; color:#888; font-size:14px;">2.5% fee ‚Ä¢ Instant delivery</p>
</div>

<script>
  let rate = 349.45;   // will be updated live

  // ===== LIVE RATE FETCHER (updates every 10 sec) =====
  async function updateRate() {
    try {
      const res = await fetch('https://api.pi.network/v1/price?currency=NGN');
      if (res.ok) { const data = await res.json(); rate = data.price || rate; }
    } catch {
      try {
        const res = await fetch('https://pi-price.herokuapp.com/ngn');
        const data = await res.json();
        rate = data.rate || rate;
      } catch {}
    }
    document.getElementById("liveRate").innerText = rate.toFixed(2);
    calculatePi(); // recalculate whenever rate changes
  }
  updateRate();
  setInterval(updateRate, 10000);

  // ===== REAL-TIME CALCULATOR =====
  document.getElementById("amount").addEventListener("input", calculatePi);
  function calculatePi() {
    const naira = parseFloat(document.getElementById("amount").value) || 0;
    if (naira < 100) {
      document.getElementById("totalPi").innerText = "0";
      document.getElementById("nairaAfterFee").innerText = "0";
      document.getElementById("feeAmount").innerText = "0";
      return;
    }
    const fee = naira * 0.025;
    const nairaAfter = naira - fee;
    const totalPi = (naira / rate).toFixed(4);

    document.getElementById("totalPi").innerText = totalPi;
    document.getElementById("nairaAfterFee").innerText = nairaAfter.toFixed(0);
    document.getElementById("feeAmount").innerText = fee.toFixed(0);
  }

  // ===== SHOW/HIDE FIELDS (your original logic) =====
  function showFields() {
    const service = document.getElementById("service").value;
    document.getElementById("phone").classList.toggle("hidden", !["airtime","data","betting"].includes(service));
    document.getElementById("networkField").classList.toggle("hidden", !["airtime","data"].includes(service));
    document.getElementById("dataPlans").classList.toggle("hidden", service !== "data");
    document.getElementById("meter").classList.toggle("hidden", service !== "electricity");
    document.getElementById("disco").classList.toggle("hidden", service !== "electricity");
    document.querySelectorAll("#bankFields input").forEach(el => el.classList.toggle("hidden", service !== "cashout"));
  }

  // ===== MAIN PAYMENT FUNCTION (one button does everything) =====
  async function payWithPi() {
    const service = document.getElementById("service").value;
    const amount = parseFloat(document.getElementById("amount").value);

    if (!service) return alert("Pick a service queen üëë");
    if (amount < 100) return alert("‚Ç¶100 minimum");

    const piAmount = Number((amount / rate).toFixed(4));

    // Build memo
    let memo = "";
    if (service === "airtime") memo = `${document.getElementById("network").value} Airtime ‚Ç¶${amount} | ${document.getElementById("phone").value}`;
    if (service === "data") memo = `${document.getElementById("network").value} Data ‚Ç¶${amount} | ${document.getElementById("phone").value}`;
    if (service === "electricity") memo = `${document.getElementById("disco").value} Electricity ‚Ç¶${amount} | Meter ${document.getElementById("meter").value}`;
    if (service === "betting") memo = `Betting Funding ‚Ç¶${amount} | ${document.getElementById("phone").value}`;
    if (service === "cashout") memo = `Cashout ‚Ç¶${amount} ‚Üí ${document.getElementById("bankName").value} ${document.getElementById("accNum").value}`;

    // Save bank details for cashout
    if (service === "cashout") {
      localStorage.bank = JSON.stringify({
        bankName: document.getElementById("bankName").value,
        accNum: document.getElementById("accNum").value,
        accName: document.getElementById("accName").value
      });
    }

    try {
      // 1. Authenticate + request payment in one flow
      const scopes = ['username', 'payments'];
      const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);

      await Pi.createPayment({
        amount: piAmount,
        memo: memo,
        metadata: {
          service,
          amount,
          phone: document.getElementById("phone").value || "",
          network: document.getElementById("network").value || "",
          disco: document.getElementById("disco").value || "",
          meter: document.getElementById("meter").value || "",
          bankDetails: localStorage.bank || ""
        }
      }, {
        onReadyForServerApproval: approvePayment,
        onReadyForServerCompletion: completePayment,
        onCancel: () => alert("Payment cancelled"),
        onError: (err) => alert("Error: " + err)
      });

    } catch (e) {
      alert("Payment cancelled or failed");
    }
  }

  // ===== BACKEND HOOKS (you‚Äôll create these API routes next) =====
  async function approvePayment(paymentId) {
    await fetch('/api/approve', { method: 'POST', body: JSON.stringify({paymentId}) });
  }
  async function completePayment(paymentId, txid) {
    await fetch('/api/complete', { method: 'POST', body: JSON.stringify({paymentId, txid}) });
    alert("Payment received üíö Delivering instantly...");
  }

  function onIncompletePaymentFound(payment) {
    console.log("Incomplete payment found:", payment);
    // optionally auto-resume
  }

  // Auto-calculate on load if amount already filled
  calculatePi();
</script>

</body>
</html>
